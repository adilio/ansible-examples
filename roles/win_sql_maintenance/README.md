## win_sql_maintenance role (Windows only)

Installs the sql_maintenance_ans scheduled task for backing up the SQL databases on a scheduled basis. 
The original scripts and files used in the role were obtained from the git package for
[sql-maintenance-ps](https://bis-src-prd.ead.ubc.ca/bis-aop/sql-maintenance-ps) and have been heavily modified.

The role can be safely applied on all hosts in the inventory as it checks whether SQL Server and a database instance 
are installed before proceeding with the rest of the tasks in the play. It also keeps any existing and older version 
of the sql_maintenance scripts and config files.

### Dependencies

This role assumes the Windows preflight playbook (win_preflight.yml) has been applied to the server already. 

### Usage

##### Prerequisites
1. The local bopsis Windows account must have the SQL sysadmin role on the SQL instance.
2. Microsoft SQL Server must be installed and configured with one active SQL instance. The minimum supported version is 
Microsoft SQL Server 2008 R2. SQL Server Express versions are not supported.
3. The backup file folder must exist before applying this role and should be a root folder named `Backup` ie. `F:\Backup`.
See notes below for details on how the role searches for this location.

Make a copy of the `ansible/playbooks/win_sql_maintenance.yml` playbook and add the host group to the `hosts` field to
target a particular set of SQL servers. Make sure to add the `&Windows` filter to target only Windows servers.
If you want to test/debug the scripts, you may want to override the notification email address field `bis_systems_email`
as shown below with your own to avoid spamming the rest of the team. If needed, set the `cl_message` variable used to set 
the changelog message on each host in play. At the very least, add your initials to the end of the text.

##### Overrides

This role added the `~/ansible/host_vars` folder to permit overrides of variables used in the role tasks on a per-host basis
since a number of the SQL Server hosts were configured with different retention periods for the backup files and start times
for the backup task, for example. Any of the role variables listed in the 'Variables' section below can be added in a host_vars
file and will override the default values set in `~/ansible/roles/win_sql_maintenance/defaults/main.yml`.

#### Example Playbook

```bash
---
- name: create windows sql_maintenance scheduled task
  hosts: ANS:&Windows

  gather_facts: yes

  vars:
    cl_message: "{{ 'Enabled' if sm_enable else 'Disabled' }} Ansible role win_sql_maintenance --DL"
    # override during testing
    #bis_systems_email: 'dewey.liew@ubc.ca'

  roles:
  - role: win_sql_maintenance
```

Test the playbook. If all is good, remove the `--check` switch and run it.
```bash
~$ cd ~/ansible
~$ ansible-playbook win_sql_maintenance.yml -i hosts/inventory.ini --ask-vault-pass --check
```

### Role Details

#### Variables

Effort has been made to keep all important variables used in the role tasks and the script config file in the 
`~/ansible/roles/win_sql_maintenance/defaults/main.yml` file. These variables can be overridden per-host in the 
`~/ansible/host_vars` folder.

* **sm_enable: true** - When true, applies the role. Removes old version of the sql_maintenance scheduled task 
  and renames the script folder. When false, removes the role if it exists, skips removing old version of the 
  sql_maintenance scheduled task and renaming the old script folder.
* **sm_bk_location: 'F:\Backup'** - Default backup file location to use. The role tests if this exists and if not, 
  searches other drives for the same root folder name and uses this instead.
* **sm_bk_fileagedays: 3**
* **sm_sql_username: 'EAD\bis-svc-dbbackup'** - SQL login account that the sql_maintenance_ans scheduled task runs as.
* **sm_st_start_boundary: '2019-06-26T18:30:00'** - Default start time for the sql_maintenance_ans scheduled task.
* **sm_st_email: '{{ bis_log_email }}'** - Notification email address for the backup job.
* **sm_bk_skip_dbs: ['db1','db2']** - List of databases to exclude from the backup.

#### Custom Facts

A number of facts are generated by this role and are cached in the fact-cache for persistence. The role tasks use many
of these variables for logical flow-handling and for setting the script config parameters.

* bis_ans_sql_server_installed
* bis_ans_sql_server_version
* bis_ans_sql_server_version_string
* bis_ans_sql_server_instance_name
* bis_ans_sql_backup_location
* bis_ans_sql_server_databases

#### Script config file sqlbkpconfig.xml

The config file for the sql_maintenance.ps1 script is now named sqlbkpconfig.xml instead of being based on the hostname
and is deployed as a template. A number of the elements are automatically populated including the &lt;instance&gt;, &lt;version&gt;, &lt;databases&gt;,
&lt;sourcefolder&gt;, &lt;fileagedays&gt; and &lt;backupDatabase&gt;&lt;location&gt; elements. These elements are determined programmatically 
by the role as described below.

* **&lt;instance&gt;** - 
  By default, set to the Ansible fact `ansible_hostname` for the default MSSQLSERVER instance. For non-default SQL Server instances,
  the role obtains the first instance name from the Windows Registry and appends this to the hostname ie. BIS-SQLSPM-PRD\ION. For cases
  where the server hostname is different from the server instance name, an override of variable `sm_bk_inst_svr_name` can be set
  per-host in `~/ansible/host_vars` ie. BIS-SQLIONPME-P.

* **&lt;version&gt;** - 
  Obtained with sqlcmd.exe query "SET NOCOUNT ON; SELECT @@VERSION;" and parsed. Misses the R2 string however such that
  `Microsoft SQL Server 2008 R2` is parsed as `2008` only instead of correctly as `2008R2`. This element should be removed from
  the config file and automatically determined by the script.

* **&lt;databases&gt;** - 
  Obtained with the sqlcmd.exe query "SET NOCOUNT ON; SELECT name FROM sys.databases". If needed, define the `sm_bk_skip_dbs` variable to list the
  databases to exclude from backup.

* **&lt;sourcefolder&gt; and &lt;backupDatabase&gt;&lt;location&gt;** - 
  These elements are the same value (should probably consider getting rid of the unused one) and sets where the backup files are written
  to. The default `F:\Backup` is set by the variable `sm_bk_location`. This path is tested by the role for existence and if not found,
  a search is made of all hard drive letters excluding A: and C: for a root-level folder named `Backup`. If found, this will be used
  instead. If no backup folder is found, the play is failed with a message.

These element(s) are not set programmatically and are set by default in `~/ansible/roles/win_sql_maintenance/defaults/main.yml` for
all hosts or overridden per-host in `~/ansible/host_vars` as needed.

* **&lt;fileagedays&gt;** - 
  This sets the retention period of the backup files. Default is 3 days and can be overridden with the `sm_bk_fileagedays` variable
  on a per-host basis in `~/ansible/host_vars`.

#### Other role tasks

These tasks are also performed by the role, which were previously done manually.

* **Batch logon rights for SQL login user** - Implemented with the `ntrights.exe` utility from the Windows Server 2003 Resource Kit Tools
available from Microsoft. The role copies the utility temporarily to the host and runs the command to grant the rights to the SQL login user
specified by the default `sm_sql_username` variable. Unfortunately, there is no simple way to do this through PowerShell.

* **Modify permissions for backup folder** - The SQL login user specified by the default `sm_sql_username` variable is granted Modify 
permissions to the backup folder lcoation using the `win_acl` Ansible module. Note that if the user account already has Full Control 
permissions, the task returns a change state (odd!). Manually removing this ACL and re-applying the role resolves this.

#### Custom host_vars folder

As mentioned earlier, an additional set of `host_var` files have been added in `/ansible/host_vars` for some hosts for overriding any variables
used in the `sqlbkpconfig.xml` script config file and the role tasks. This folder is different from the `~/ansible/hosts/host_vars` folder that is 
currently generated programmatically by the inventory script.

### Compatibility

Tested on Ansible version 2.7.10

**SQL Version**|**Windows OS Version**|**Role Tested**|**Role Working**
-----|-----|-----|-----
Microsoft SQL Server 2008 Standard|Windows Server 2008 R2|Yes|No
Microsoft SQL Server 2008 R2 Standard|Windows Server 2008 R2|Yes|Yes
Microsoft SQL Server 2012 Express|Windows Server 2012 R2|Yes|No
Microsoft SQL Server 2014 Standard|Windows Server 2012 R2|Yes|Yes
Microsoft SQL Server 2016 Standard|Windows Server 2016|Yes|Yes
Microsoft SQL Server 2017 Standard|Windows Server 2016|Yes|Yes

The compatibility of the role depends more on the version of SQL Server than on the Windows OS version. The role does not
work on older SQL Server versions or the Express Editions that are missing the SQL Server instance registry keys. The play
will incorrectly report the host as not having SQL Server installed.

Note that not all combinations of Windows OS and SQL Server versions have been tested. In general, there are no combinations
of older SQL Server versions and newer Windows OS versions and vice-versa present in our environment.

### Issues

### To-Do List

1. Remove **&lt;fileagedays&gt;** from the script config file and set value programmatically by calculating space available and estimated backup size.
2. Remove **&lt;version&gt;** from the script config file and code and set value programmatically.
3. Add support for multiple SQL instances.
4. Remove **&lt;instance&gt;** from the script config file and set value programmatically.
5. Add support for SQL Server Express.
